<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sonify</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500&family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
<style>
  /* ================================================================
     DESIGN TOKENS
     ================================================================ */
  :root {
    --bg: #08090c;
    --surface: #0e1014;
    --surface-raised: #13151b;
    --border: #1c1f28;
    --border-active: #2a2e3a;
    --text: #c8cad0;
    --text-dim: #5e6270;
    --text-bright: #ecedf0;

    /* Phosphor green -- primary accent */
    --phosphor: #39ff85;
    --phosphor-dim: #39ff8540;
    --phosphor-faint: #39ff8518;
    --phosphor-bg: #0b1f14;

    /* Amber -- secondary accent for warmth */
    --amber: #ffb938;
    --amber-dim: #ffb93840;
    --amber-faint: #ffb93815;

    /* Signal red -- alerts/arrhythmia */
    --signal-red: #ff4d5a;
    --signal-red-dim: #ff4d5a30;

    /* Cyan -- tertiary for data */
    --cyan: #38d9ff;
    --cyan-dim: #38d9ff30;

    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 10px;

    --mono: 'DM Mono', 'Consolas', 'SF Mono', monospace;
    --sans: 'Instrument Sans', 'Inter', system-ui, sans-serif;

    --sidebar-w: 296px;
  }

  /* ================================================================
     RESET & BASE
     ================================================================ */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-active); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* ================================================================
     HEADER -- instrument top bar
     ================================================================ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 48px;
    min-height: 48px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    z-index: 10;
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 0;
    user-select: none;
  }

  .logo-main {
    font-family: var(--mono);
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 2px;
    color: var(--text-bright);
    text-transform: uppercase;
  }

  .logo-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--phosphor);
    margin-left: 4px;
    box-shadow: 0 0 6px var(--phosphor), 0 0 12px var(--phosphor-dim);
    animation: logo-pulse 3s ease-in-out infinite;
    vertical-align: middle;
    position: relative;
    top: -1px;
  }

  @keyframes logo-pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--phosphor), 0 0 12px var(--phosphor-dim); }
    50% { opacity: 0.6; box-shadow: 0 0 3px var(--phosphor), 0 0 6px var(--phosphor-dim); }
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ── Backend badge ── */
  .badge {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 400;
    padding: 3px 10px;
    border-radius: 3px;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    border: 1px solid;
    background: var(--phosphor-bg);
    color: var(--phosphor);
    border-color: var(--phosphor-dim);
  }

  .badge.mock {
    background: var(--amber-faint);
    color: var(--amber);
    border-color: var(--amber-dim);
  }

  .badge.elevenlabs {
    background: var(--cyan-dim);
    color: var(--cyan);
    border-color: var(--cyan-dim);
  }

  /* ── Play/Pause button ── */
  .play-pause-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 13px;
    line-height: 1;
  }

  .play-pause-btn:hover {
    border-color: var(--phosphor-dim);
    color: var(--phosphor);
    background: var(--phosphor-faint);
  }

  .play-pause-btn.playing {
    border-color: var(--phosphor);
    color: var(--phosphor);
    box-shadow: 0 0 8px var(--phosphor-faint);
  }

  .play-pause-btn:disabled {
    opacity: 0.3;
    cursor: default;
  }

  /* ================================================================
     MAIN LAYOUT
     ================================================================ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ================================================================
     SIDEBAR -- control panel
     ================================================================ */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .sidebar section {
    padding: 16px 18px;
    border-bottom: 1px solid var(--border);
  }

  .section-header {
    font-family: var(--mono);
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* ── Lens selector ── */
  .lens-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .lens-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 6px 8px;
    background: var(--surface-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-dim);
    font-size: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .lens-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--phosphor);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .lens-btn:hover {
    border-color: var(--border-active);
    color: var(--text);
    background: var(--surface-raised);
  }

  .lens-btn.active {
    border-color: var(--phosphor-dim);
    color: var(--phosphor);
    background: var(--phosphor-faint);
  }

  .lens-btn.active::before {
    opacity: 1;
  }

  .lens-icon {
    font-size: 18px;
    margin-bottom: 4px;
    line-height: 1;
  }

  .lens-name {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .lens-desc {
    font-size: 9px;
    color: var(--text-dim);
    margin-top: 2px;
    line-height: 1.3;
  }

  .lens-btn.active .lens-desc { color: var(--phosphor-dim); }

  /* ── Parameter sliders ── */
  .param-group {
    margin-bottom: 14px;
  }

  .param-group:last-child {
    margin-bottom: 0;
  }

  .param-label {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 11px;
    margin-bottom: 6px;
    color: var(--text);
  }

  .param-value {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--phosphor);
    font-weight: 400;
    min-width: 36px;
    text-align: right;
  }

  .slider-track {
    position: relative;
    width: 100%;
    height: 20px;
    display: flex;
    align-items: center;
  }

  input[type="range"] {
    width: 100%;
    height: 3px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    position: relative;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background: var(--phosphor);
    cursor: pointer;
    box-shadow: 0 0 6px var(--phosphor-dim);
    transition: box-shadow 0.15s ease;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    box-shadow: 0 0 10px var(--phosphor-dim), 0 0 20px var(--phosphor-faint);
  }

  input[type="range"]::-moz-range-thumb {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background: var(--phosphor);
    border: none;
    cursor: pointer;
  }

  .param-effects {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--text-dim);
    margin-top: 4px;
    line-height: 1.6;
    padding-left: 8px;
    border-left: 1px solid var(--border);
    opacity: 0.7;
  }

  /* ── Live weather toggle ── */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 11px;
    padding: 8px 10px;
    background: var(--surface-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
  }

  .toggle-label-text {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text);
  }

  .toggle-indicator {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: all 0.3s ease;
  }

  .toggle-indicator.on {
    background: var(--phosphor);
    box-shadow: 0 0 4px var(--phosphor);
  }

  .toggle {
    position: relative;
    width: 34px;
    height: 18px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .toggle input { display: none; }

  .toggle-track {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 9px;
    transition: background 0.25s ease;
    border: 1px solid var(--border-active);
  }

  .toggle input:checked + .toggle-track {
    background: var(--phosphor-dim);
    border-color: var(--phosphor);
  }

  .toggle-knob {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 12px;
    height: 12px;
    background: var(--text-dim);
    border-radius: 50%;
    transition: all 0.25s ease;
    pointer-events: none;
  }

  .toggle input:checked ~ .toggle-knob {
    transform: translateX(16px);
    background: var(--phosphor);
    box-shadow: 0 0 6px var(--phosphor-dim);
  }

  /* ── Controls readout (meter bars) ── */
  .control-bar {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 10px;
    gap: 8px;
  }

  .control-bar:last-child { margin-bottom: 0; }

  .control-bar .label {
    font-family: var(--mono);
    width: 64px;
    color: var(--text-dim);
    font-size: 9px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    flex-shrink: 0;
  }

  .control-bar .bar-bg {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 1px;
    overflow: hidden;
    position: relative;
  }

  .control-bar .bar-bg::after {
    content: '';
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 3px,
      var(--surface) 3px,
      var(--surface) 4px
    );
    opacity: 0.3;
    pointer-events: none;
  }

  .control-bar .bar-fill {
    height: 100%;
    border-radius: 1px;
    transition: width 0.3s ease;
    position: relative;
  }

  .control-bar .val {
    font-family: var(--mono);
    width: 36px;
    text-align: right;
    font-weight: 400;
    font-size: 10px;
    flex-shrink: 0;
  }

  /* Color coding for each meter */
  .meter-bpm .bar-fill { background: var(--phosphor); }
  .meter-bpm .val { color: var(--phosphor); }

  .meter-density .bar-fill { background: var(--cyan); }
  .meter-density .val { color: var(--cyan); }

  .meter-brightness .bar-fill { background: var(--amber); }
  .meter-brightness .val { color: var(--amber); }

  .meter-guidance .bar-fill { background: #c084fc; }
  .meter-guidance .val { color: #c084fc; }

  /* ── Prompts display ── */
  .prompts-list {
    font-size: 10px;
    max-height: 80px;
    overflow-y: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .prompt-chip {
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    background: var(--phosphor-faint);
    border: 1px solid var(--phosphor-dim);
    border-radius: 3px;
    font-family: var(--mono);
    font-size: 9px;
    color: var(--phosphor);
    letter-spacing: 0.3px;
  }

  .prompts-empty {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--text-dim);
    font-style: italic;
  }

  /* ================================================================
     CANVAS AREA -- oscilloscope viewport
     ================================================================ */
  .canvas-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    background: var(--bg);
  }

  /* CRT scanline overlay */
  .canvas-wrap::after {
    content: '';
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 0, 0, 0.04) 2px,
      rgba(0, 0, 0, 0.04) 4px
    );
    pointer-events: none;
    z-index: 2;
  }

  /* Vignette */
  .canvas-vignette {
    position: absolute;
    inset: 0;
    background: radial-gradient(
      ellipse at center,
      transparent 50%,
      rgba(8, 9, 12, 0.4) 80%,
      rgba(8, 9, 12, 0.85) 100%
    );
    pointer-events: none;
    z-index: 3;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* ── Data overlay (top-right readout) ── */
  .data-overlay {
    position: absolute;
    top: 14px;
    right: 14px;
    background: rgba(8, 9, 12, 0.88);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    line-height: 1.8;
    pointer-events: none;
    z-index: 5;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .data-key {
    color: var(--phosphor);
  }

  /* ── Lens label (top-left) ── */
  .lens-label {
    position: absolute;
    top: 14px;
    left: 14px;
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    z-index: 5;
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .lens-label-dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--phosphor);
    box-shadow: 0 0 4px var(--phosphor);
    animation: lens-dot-blink 2s ease-in-out infinite;
  }

  @keyframes lens-dot-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .lens-label.paused .lens-label-dot {
    background: var(--amber);
    box-shadow: 0 0 4px var(--amber);
    animation: none;
  }

  /* ================================================================
     START OVERLAY
     ================================================================ */
  .start-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(8, 9, 12, 0.96);
    z-index: 20;
    cursor: pointer;
    transition: opacity 0.5s ease, visibility 0.5s ease;
  }

  .start-overlay.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .start-logo {
    font-family: var(--mono);
    font-size: 32px;
    font-weight: 500;
    letter-spacing: 8px;
    color: var(--text-bright);
    text-transform: uppercase;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .start-logo .logo-dot {
    width: 8px;
    height: 8px;
    margin-left: 4px;
  }

  .start-tagline {
    font-family: var(--sans);
    color: var(--text-dim);
    font-size: 13px;
    font-weight: 400;
    margin-bottom: 36px;
    letter-spacing: 0.5px;
  }

  .start-btn {
    padding: 10px 36px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    background: transparent;
    color: var(--phosphor);
    border: 1px solid var(--phosphor);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .start-btn:hover {
    background: var(--phosphor-faint);
    box-shadow: 0 0 20px var(--phosphor-faint), inset 0 0 20px var(--phosphor-faint);
  }

  .start-btn:active {
    transform: scale(0.98);
  }

  /* Decorative grid lines on start overlay */
  .start-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.15;
    pointer-events: none;
  }

  /* Corner markers */
  .corner-mark {
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: var(--text-dim);
    border-style: solid;
    opacity: 0.3;
    pointer-events: none;
    z-index: 4;
  }
  .corner-mark.tl { top: 8px; left: 8px; border-width: 1px 0 0 1px; }
  .corner-mark.tr { top: 8px; right: 8px; border-width: 1px 1px 0 0; }
  .corner-mark.bl { bottom: 8px; left: 8px; border-width: 0 0 1px 1px; }
  .corner-mark.br { bottom: 8px; right: 8px; border-width: 0 1px 1px 0; }

  /* ================================================================
     ANIMATIONS -- page load stagger
     ================================================================ */
  @keyframes fade-slide-up {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .sidebar section {
    animation: fade-slide-up 0.4s ease both;
  }

  .sidebar section:nth-child(1) { animation-delay: 0.05s; }
  .sidebar section:nth-child(2) { animation-delay: 0.1s; }
  .sidebar section:nth-child(3) { animation-delay: 0.15s; }
  .sidebar section:nth-child(4) { animation-delay: 0.2s; }

  header {
    animation: fade-slide-up 0.3s ease both;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-main">Sonify</span>
    <span class="logo-dot"></span>
  </div>
  <div class="header-right">
    <div id="status-badge" class="badge">CONNECTING</div>
    <button id="play-pause-btn" class="play-pause-btn" title="Play / Pause" disabled>&#9654;</button>
  </div>
</header>

<div class="main">
  <!-- Sidebar: control panel -->
  <aside class="sidebar">
    <section>
      <div class="section-header">Lens</div>
      <div id="lens-buttons" class="lens-grid"></div>
    </section>

    <section id="params-section">
      <div class="section-header">Parameters</div>
      <div id="param-sliders"></div>
      <div id="live-toggle-wrap" style="display:none">
        <div class="toggle-row">
          <span class="toggle-label-text">
            <span class="toggle-indicator" id="live-indicator"></span>
            Live Weather
          </span>
          <label class="toggle">
            <input type="checkbox" id="live-toggle">
            <div class="toggle-track"></div>
            <div class="toggle-knob"></div>
          </label>
        </div>
      </div>
    </section>

    <section>
      <div class="section-header">Output Meters</div>
      <div id="controls-readout">
        <div class="control-bar meter-bpm">
          <span class="label">BPM</span>
          <div class="bar-bg"><div class="bar-fill" id="bar-bpm" style="width:50%"></div></div>
          <span class="val" id="val-bpm">120</span>
        </div>
        <div class="control-bar meter-density">
          <span class="label">Density</span>
          <div class="bar-bg"><div class="bar-fill" id="bar-density" style="width:50%"></div></div>
          <span class="val" id="val-density">0.50</span>
        </div>
        <div class="control-bar meter-brightness">
          <span class="label">Bright</span>
          <div class="bar-bg"><div class="bar-fill" id="bar-brightness" style="width:50%"></div></div>
          <span class="val" id="val-brightness">0.50</span>
        </div>
        <div class="control-bar meter-guidance">
          <span class="label">Guide</span>
          <div class="bar-bg"><div class="bar-fill" id="bar-guidance" style="width:67%"></div></div>
          <span class="val" id="val-guidance">4.0</span>
        </div>
      </div>
    </section>

    <section>
      <div class="section-header">Prompts</div>
      <div id="prompts-display" class="prompts-list">
        <span class="prompts-empty">Waiting for data...</span>
      </div>
    </section>
  </aside>

  <!-- Canvas viewport -->
  <div class="canvas-wrap">
    <div class="canvas-vignette"></div>
    <div class="corner-mark tl"></div>
    <div class="corner-mark tr"></div>
    <div class="corner-mark bl"></div>
    <div class="corner-mark br"></div>
    <div class="lens-label" id="lens-label">
      <span class="lens-label-dot"></span>
      <span id="lens-label-text">Atmosphere</span>
    </div>
    <canvas id="viz-canvas"></canvas>
    <div class="data-overlay" id="data-overlay"></div>

    <div class="start-overlay" id="start-overlay">
      <div class="start-grid"></div>
      <div class="start-logo">Sonify<span class="logo-dot"></span></div>
      <p class="start-tagline">Hear what numbers hide. See what sound reveals.</p>
      <button class="start-btn" id="start-btn">Initialize</button>
    </div>
  </div>
</div>

<script>
// =====================================================================
// State
// =====================================================================
let ws = null;
let audioCtx = null;
let workletNode = null;
let currentLens = 'atmosphere';
let vizState = null;
let lensesInfo = {};
let animFrame = null;
let isPaused = false;
const canvas = document.getElementById('viz-canvas');
const ctx = canvas.getContext('2d');
const playPauseBtn = document.getElementById('play-pause-btn');

// =====================================================================
// Audio setup
// =====================================================================
async function initAudio() {
  audioCtx = new AudioContext({ sampleRate: 48000 });
  await audioCtx.audioWorklet.addModule('/static/worklet.js');
  workletNode = new AudioWorkletNode(audioCtx, 'pcm-player-processor', {
    outputChannelCount: [2],
  });
  workletNode.connect(audioCtx.destination);
  if (audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }
}

// =====================================================================
// WebSocket
// =====================================================================
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    document.getElementById('status-badge').textContent = 'CONNECTED';
    document.getElementById('status-badge').className = 'badge';
  };

  ws.onmessage = (event) => {
    if (event.data instanceof ArrayBuffer) {
      // Binary: PCM audio
      if (workletNode) {
        workletNode.port.postMessage(event.data, [event.data]);
      }
    } else {
      // Text: JSON state
      const msg = JSON.parse(event.data);

      if (msg.type === 'init') {
        lensesInfo = msg.lenses;
        currentLens = msg.lens;
        updateMockBadge(msg.is_mock, msg.backend);
        updatePlayPauseUI(msg.paused || false);
        playPauseBtn.disabled = false;
        buildLensButtons();
        buildParamSliders();
        updateLensLabel();
        return;
      }

      if (msg.type === 'paused') {
        updatePlayPauseUI(msg.paused);
        return;
      }

      if (msg.viz) vizState = msg.viz;
      if (msg.controls) updateControlsReadout(msg.controls);
      if (msg.is_mock !== undefined) updateMockBadge(msg.is_mock, msg.backend);
      if (msg.lens) {
        currentLens = msg.lens;
        highlightActiveLens();
        updateLensLabel();
      }
    }
  };

  ws.onclose = () => {
    document.getElementById('status-badge').textContent = 'OFFLINE';
    document.getElementById('status-badge').className = 'badge mock';
    setTimeout(connectWS, 2000);
  };

  ws.onerror = () => ws.close();
}

function sendMsg(data) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(data));
  }
}

function updatePlayPauseUI(paused) {
  isPaused = paused;
  playPauseBtn.innerHTML = isPaused ? '&#9654;' : '&#9646;&#9646;';
  playPauseBtn.title = isPaused ? 'Play' : 'Pause';
  playPauseBtn.classList.toggle('playing', !isPaused);

  // Update lens label pause state
  const lensLabel = document.getElementById('lens-label');
  lensLabel.classList.toggle('paused', isPaused);

  // Suspend/resume AudioContext for clean silence
  if (audioCtx) {
    if (isPaused) {
      audioCtx.suspend();
    } else {
      audioCtx.resume();
    }
  }
}

// =====================================================================
// UI builders
// =====================================================================
function updateMockBadge(isMock, backend) {
  const badge = document.getElementById('status-badge');
  if (isMock) {
    badge.textContent = 'MOCK';
    badge.className = 'badge mock';
  } else if (backend === 'elevenlabs') {
    badge.textContent = 'ELEVENLABS';
    badge.className = 'badge elevenlabs';
  } else {
    badge.textContent = 'LYRIA RT';
    badge.className = 'badge';
  }
}

function updateLensLabel() {
  const text = document.getElementById('lens-label-text');
  const names = { atmosphere: 'Atmosphere', pulse: 'Pulse', lattice: 'Lattice', flow: 'Flow' };
  text.textContent = names[currentLens] || currentLens;
}

function buildLensButtons() {
  const container = document.getElementById('lens-buttons');
  container.innerHTML = '';

  const lensOrder = ['atmosphere', 'pulse', 'lattice', 'flow'];
  const icons = { atmosphere: '\u2601', pulse: '\u2665', lattice: '\u2227', flow: '\u21c4' };

  for (const name of lensOrder) {
    const info = lensesInfo[name];
    if (!info) continue;
    const btn = document.createElement('button');
    btn.className = 'lens-btn' + (name === currentLens ? ' active' : '');
    btn.dataset.lens = name;
    btn.innerHTML = `
      <div class="lens-icon">${icons[name] || ''}</div>
      <div class="lens-name">${name.charAt(0).toUpperCase() + name.slice(1)}</div>
      <div class="lens-desc">${info.description}</div>`;
    btn.onclick = () => {
      sendMsg({ type: 'switch_lens', lens: name });
      currentLens = name;
      highlightActiveLens();
      buildParamSliders();
      updateLensLabel();
    };
    container.appendChild(btn);
  }
}

function highlightActiveLens() {
  document.querySelectorAll('.lens-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.lens === currentLens);
  });
}

function buildParamSliders() {
  const container = document.getElementById('param-sliders');
  container.innerHTML = '';

  const info = lensesInfo[currentLens];
  if (!info) return;

  for (const p of info.parameters) {
    const group = document.createElement('div');
    group.className = 'param-group';

    const label = document.createElement('div');
    label.className = 'param-label';
    label.innerHTML = `<span>${p.label}</span><span class="param-value" id="pv-${p.name}">${p.default.toFixed(2)}</span>`;

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = p.min;
    slider.max = p.max;
    slider.step = p.step;
    slider.value = p.default;
    slider.oninput = () => {
      const val = parseFloat(slider.value);
      document.getElementById(`pv-${p.name}`).textContent = val.toFixed(2);
      sendMsg({ type: 'set_param', name: p.name, value: val });
    };

    group.appendChild(label);
    group.appendChild(slider);

    if (p.effects && p.effects.length > 0) {
      const effects = document.createElement('div');
      effects.className = 'param-effects';
      effects.innerHTML = p.effects.join('<br>');
      group.appendChild(effects);
    }

    container.appendChild(group);
  }

  // Show/hide live toggle for atmosphere
  const liveWrap = document.getElementById('live-toggle-wrap');
  liveWrap.style.display = currentLens === 'atmosphere' ? 'block' : 'none';
}

function updateControlsReadout(controls) {
  // BPM: range 60-200
  const bpmPct = ((controls.bpm - 60) / 140) * 100;
  document.getElementById('bar-bpm').style.width = bpmPct + '%';
  document.getElementById('val-bpm').textContent = controls.bpm;

  // Density: 0-1
  document.getElementById('bar-density').style.width = (controls.density * 100) + '%';
  document.getElementById('val-density').textContent = controls.density.toFixed(2);

  // Brightness: 0-1
  document.getElementById('bar-brightness').style.width = (controls.brightness * 100) + '%';
  document.getElementById('val-brightness').textContent = controls.brightness.toFixed(2);

  // Guidance: 0-6
  document.getElementById('bar-guidance').style.width = ((controls.guidance / 6) * 100) + '%';
  document.getElementById('val-guidance').textContent = controls.guidance.toFixed(1);

  // Prompts
  const pd = document.getElementById('prompts-display');
  if (controls.prompts && controls.prompts.length > 0) {
    pd.innerHTML = controls.prompts.map(p =>
      `<span class="prompt-chip">${p.text} (${p.weight.toFixed(1)})</span>`
    ).join('');
  } else {
    pd.innerHTML = '<span class="prompts-empty">No active prompts</span>';
  }
}

// =====================================================================
// Canvas renderers
// =====================================================================
function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * devicePixelRatio;
  canvas.height = rect.height * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
}

// -- Atmosphere particles --
const particles = [];
function initParticles(count) {
  particles.length = 0;
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  for (let i = 0; i < count; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      vx: 0, vy: 0,
      size: 2 + Math.random() * 2,
      alpha: 0.3 + Math.random() * 0.5,
    });
  }
}

function renderAtmosphere(state) {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  const c = state.color || { r: 150, g: 200, b: 230 };
  const vel = state.particle_velocity || 0.3;
  const targetCount = state.particle_count || 100;

  // Adjust particle count
  while (particles.length < targetCount) {
    particles.push({ x: Math.random() * w, y: -10, vx: 0, vy: 0, size: 2, alpha: 0.4 });
  }
  while (particles.length > targetCount + 20) particles.pop();

  // Update particles
  const windAngle = state.wind_angle || 0;
  const wx = Math.cos(windAngle) * vel * 3;
  const wy = Math.sin(windAngle) * vel * 1.5 + 0.3;

  for (const p of particles) {
    p.vx += (wx - p.vx) * 0.05;
    p.vy += (wy - p.vy) * 0.05;
    p.x += p.vx;
    p.y += p.vy;

    if (p.x > w + 10) p.x = -10;
    if (p.x < -10) p.x = w + 10;
    if (p.y > h + 10) { p.y = -10; p.x = Math.random() * w; }
    if (p.y < -10) p.y = h + 10;
  }

  // Draw
  ctx.fillStyle = `rgba(${Math.max(0, c.r - 140)}, ${Math.max(0, c.g - 140)}, ${Math.max(0, c.b - 140)}, 0.15)`;
  ctx.fillRect(0, 0, w, h);

  for (const p of particles) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, state.particle_size || p.size, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, ${p.alpha})`;
    ctx.fill();
  }

  // Rain drops
  if (state.rain_drops) {
    ctx.strokeStyle = `rgba(180, 200, 255, 0.3)`;
    ctx.lineWidth = 1;
    for (let i = 0; i < 30; i++) {
      const rx = Math.random() * w;
      const ry = Math.random() * h;
      ctx.beginPath();
      ctx.moveTo(rx, ry);
      ctx.lineTo(rx + wx * 3, ry + 8);
      ctx.stroke();
    }
  }

  // Lightning flash
  if (state.lightning && Math.random() < 0.03) {
    ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
    ctx.fillRect(0, 0, w, h);
  }

  renderDataOverlay(state.data);
}

// -- Pulse ECG --
function renderPulse(state) {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  const c = state.color || { r: 80, g: 220, b: 120 };

  // Clear with fade
  ctx.fillStyle = 'rgba(10, 10, 15, 0.12)';
  ctx.fillRect(0, 0, w, h);

  // Draw ECG trace
  const history = state.ecg_history || [];
  if (history.length > 1) {
    const traceH = h * 0.4;
    const traceY = h * 0.35;
    const stepX = w / Math.max(200, history.length);

    ctx.beginPath();
    ctx.strokeStyle = `rgb(${c.r}, ${c.g}, ${c.b})`;
    ctx.lineWidth = 2;
    ctx.shadowBlur = 8;
    ctx.shadowColor = `rgb(${c.r}, ${c.g}, ${c.b})`;

    for (let i = 0; i < history.length; i++) {
      const x = i * stepX;
      const y = traceY - history[i] * traceH * 0.5;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  // Pulsing circle
  const pulseSize = (state.pulse_size || 0.5) * Math.min(w, h) * 0.2;
  const cx = w * 0.5;
  const cy = h * 0.75;

  ctx.beginPath();
  ctx.arc(cx, cy, pulseSize, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.15)`;
  ctx.fill();
  ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.6)`;
  ctx.lineWidth = 2;
  ctx.stroke();

  // Arrhythmia flash
  if (state.arrhythmia) {
    ctx.fillStyle = 'rgba(255, 50, 50, 0.1)';
    ctx.fillRect(0, 0, w, h);
  }

  renderDataOverlay(state.data);
}

// -- Lattice --
function renderLattice(state) {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  const c = state.color || { r: 150, g: 100, b: 255 };
  const glow = state.glow_intensity || 0.5;

  // Fade
  ctx.fillStyle = `rgba(10, 10, 15, 0.08)`;
  ctx.fillRect(0, 0, w, h);

  if (state.mode === 'lorenz') {
    const trail = state.trail || [];
    if (trail.length > 1) {
      const scaleX = w / 60;
      const scaleY = h / 50;
      const offsetX = w / 2;
      const offsetY = h / 2;

      ctx.beginPath();
      ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.7)`;
      ctx.lineWidth = 1.5;
      ctx.shadowBlur = glow * 15;
      ctx.shadowColor = `rgb(${c.r}, ${c.g}, ${c.b})`;

      for (let i = 0; i < trail.length; i++) {
        const x = trail[i][0] * scaleX + offsetX;
        const y = trail[i][1] * scaleY + offsetY;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
      ctx.shadowBlur = 0;

      // Current point
      if (state.current) {
        const cx = state.current.x * scaleX + offsetX;
        const cy = state.current.y * scaleY + offsetY;
        ctx.beginPath();
        ctx.arc(cx, cy, 4, 0, Math.PI * 2);
        ctx.fillStyle = `rgb(${c.r}, ${c.g}, ${c.b})`;
        ctx.fill();
      }
    }
  } else if (state.mode === 'logistic') {
    const iterations = state.iterations || [];
    if (iterations.length > 0) {
      const stepX = w / iterations.length;
      const scaleY = h * 0.8;
      const offsetY = h * 0.1;

      ctx.beginPath();
      ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.8)`;
      ctx.lineWidth = 2;

      for (let i = 0; i < iterations.length; i++) {
        const x = i * stepX;
        const y = offsetY + (1 - iterations[i]) * scaleY;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.5)`;
      for (let i = 0; i < iterations.length; i++) {
        ctx.beginPath();
        ctx.arc(i * stepX, offsetY + (1 - iterations[i]) * scaleY, 2, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  } else {
    // Sine superposition
    const components = state.components || [];
    const t = performance.now() / 1000;

    for (let comp = 0; comp < components.length; comp++) {
      const { freq, amp } = components[comp];
      ctx.beginPath();
      ctx.strokeStyle = `rgba(${c.r}, ${c.g + comp * 20}, ${c.b - comp * 30}, ${0.4 + amp})`;
      ctx.lineWidth = 1.5;

      for (let x = 0; x < w; x += 2) {
        const y = h / 2 + Math.sin((x / w) * Math.PI * 4 * freq + t * freq) * amp * h * 0.3;
        if (x === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }
  }

  renderDataOverlay(state.data);
}

// -- Flow network --
function renderFlow(state) {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  const c = state.color || { r: 50, g: 200, b: 200 };
  const pulse = state.pulse_intensity || 0.3;

  // Clear
  ctx.fillStyle = 'rgba(10, 10, 15, 0.15)';
  ctx.fillRect(0, 0, w, h);

  const nodes = state.nodes || [];
  const edges = state.active_edges || [];
  const margin = 60;
  const nodeGlow = state.node_glow || 0.5;

  // Draw edges
  ctx.lineWidth = 1.5;
  for (const edge of edges) {
    const src = nodes[edge.src];
    const dst = nodes[edge.dst];
    if (!src || !dst) continue;

    const x1 = margin + src.x * (w - margin * 2);
    const y1 = margin + src.y * (h - margin * 2);
    const x2 = margin + dst.x * (w - margin * 2);
    const y2 = margin + dst.y * (h - margin * 2);

    const alpha = 0.3 + (edge.packets / 5) * 0.5;
    ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, ${alpha})`;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Packet dot animation along edge
    const progress = (performance.now() / 500) % 1;
    const px = x1 + (x2 - x1) * progress;
    const py = y1 + (y2 - y1) * progress;
    ctx.beginPath();
    ctx.arc(px, py, 3, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.8)`;
    ctx.fill();
  }

  // Draw nodes
  for (const node of nodes) {
    const x = margin + node.x * (w - margin * 2);
    const y = margin + node.y * (h - margin * 2);
    const radius = 8 + pulse * 8;

    // Glow
    ctx.beginPath();
    ctx.arc(x, y, radius + nodeGlow * 10, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, ${nodeGlow * 0.15})`;
    ctx.fill();

    // Node
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.6)`;
    ctx.fill();
    ctx.strokeStyle = `rgba(${c.r}, ${c.g}, ${c.b}, 0.9)`;
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // Burst flash
  if (state.is_burst) {
    ctx.fillStyle = 'rgba(255, 60, 60, 0.05)';
    ctx.fillRect(0, 0, w, h);
  }

  renderDataOverlay(state.data);
}

// -- Data overlay --
function renderDataOverlay(data) {
  const el = document.getElementById('data-overlay');
  if (!data) { el.textContent = ''; return; }

  el.innerHTML = Object.entries(data).map(([k, v]) => {
    const val = typeof v === 'number' ? v.toFixed(2) : v;
    return `<span class="data-key">${k}:</span> ${val}`;
  }).join('<br>');
}

// -- Animation loop --
function animate() {
  if (vizState && !isPaused) {
    const type = vizState.type;
    if (type === 'atmosphere') renderAtmosphere(vizState);
    else if (type === 'pulse') renderPulse(vizState);
    else if (type === 'lattice') renderLattice(vizState);
    else if (type === 'flow') renderFlow(vizState);
  }
  animFrame = requestAnimationFrame(animate);
}

// =====================================================================
// Initialization
// =====================================================================
window.addEventListener('resize', resizeCanvas);

document.getElementById('start-btn').addEventListener('click', async () => {
  document.getElementById('start-overlay').classList.add('hidden');
  await initAudio();
  resizeCanvas();
  initParticles(150);
  connectWS();
  animate();
});

// Play/Pause button
playPauseBtn.addEventListener('click', () => {
  if (isPaused) {
    sendMsg({ type: 'play' });
  } else {
    sendMsg({ type: 'pause' });
  }
});

// Live weather toggle
document.getElementById('live-toggle').addEventListener('change', (e) => {
  sendMsg({ type: 'toggle_live', enabled: e.target.checked });
  document.getElementById('live-indicator').classList.toggle('on', e.target.checked);
});
</script>
</body>
</html>
